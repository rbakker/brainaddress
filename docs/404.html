<div id="response">Resolving brain address...</div>
<script type="text/javascript">
/*
 * mini-library for submitting ajax requests
 * adapted from https://github.com/argunner/minAjax.js/blob/master/minify/index.min.js
 */
function xhr_init(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}
function xhr_headers(h,o,rt){o.responseType=rt?rt:'text';for(k in h)o.setRequestHeader(k,h[k])}
function ajaxRequest(e){
  if(!e.url)return void(1==e.debugLog&&console.log("No Url!"))
  if(!e.type)return void(1==e.debugLog&&console.log("No type (GET/POST) given!"))
  e.method||(e.method=!0),e.debugLog||(e.debugLog=!1)
  var o=xhr_init()
  o.onreadystatechange=function(){
    if(4==o.readyState)200==o.status?(e.success&&e.success(o),1==e.debugLog&&console.log("SuccessResponse"),1==e.debugLog&&console.log("Response Data:"+o.responseText)):e.fail&&e.fail(o),1==e.debugLog&&console.log("FailureResponse --> State:"+o.readyState+"Status:"+o.status)
  }
  var t=[],n=e.data,q=e.url
  if("string"==typeof n)for(var s=String.prototype.split.call(n,"&"),r=0,a=s.length;a>r;r++){
    var c=s[r].split("=");t.push(encodeURIComponent(c[0])+"="+encodeURIComponent(c[1]))
  }else if("object"==typeof n&&!(n instanceof String||FormData&&n instanceof FormData))for(var p in n){
    var c=n[p]
    if("[object Array]"==Object.prototype.toString.call(c))for(var r=0,a=c.length;a>r;r++)t.push(encodeURIComponent(p)+"[]="+encodeURIComponent(c[r]))
    else t.push(encodeURIComponent(p)+"="+encodeURIComponent(c))
  }
  t=t.join("&"),h=e.headers||(h=[])
  "GET"==e.type&&(o.requestUrl=q=q+"?"+t,o.open("GET",q,e.method),xhr_headers(h,o,e.responseType),o.send(),1==e.debugLog&&console.log("GET fired at:"+q))
  "POST"==e.type&&(o.open("POST",o.requestUrl=q,e.method),xhr_headers(h.push("Content-type","application/x-www-form-urlencoded"),o,e.responseType),o.send(t),1==e.debugLog&&console.log("POST fired at:"+q+" || Data:"+t))
}
function ajaxPromise(e){
  return new Promise((resolve, reject) => {
    e.success = resolve;
    e.fail = reject;
    ajaxRequest(e);
  });
}

/*
 * cleanup dirty (unsafe) data before outputting as html: make sure no function can be called.
 */
const sanitize = (s) => {
  const text = document.createTextNode(s);
  const p = document.createElement('p');
  p.appendChild(text);
  return p.innerHTML;
}
const sanitizeUrl = (s) => {
  s = sanitize(s);
  return (s.substr(0,5) === 'http:' || s.substr(0,6) === 'https:' ) ? s : ''; 
}

const displayResponse = (html,errors) => {
  if (errors.length) {
    html.push('<li>The parser encountered '+errors.length+' errors:</li>');
    html.push('<ul>');
    for (let i=0; i<errors.length; i++) {
      html.push('<li>'+errors[i]+'</li>');
    }
    html.push('</ul>');
  }
  document.getElementById('response').innerHTML = html.join('\n');
}

let atlas = location.pathname;
let provider;
if (atlas.charAt(0)=='/') atlas = atlas.slice(1);
let loc = location.search;
if (loc.charAt(0)=='?') loc = loc.slice(1);
let hash = location.hash.trim();
if (hash.charAt(0)=='#') hash = hash.slice(1);
const html = ['<h3>Parsing address "brainaddress:'+atlas+'?'+loc+'#'+hash+'".</h3>'];
const errors = [];
html.push('<ul>');
atlas = atlas.split('/');
if (atlas.length === 2) {
  provider = atlas[0];
  atlas = atlas[1];
  html.push('<li>The provider is "'+provider+'".</li>');
  html.push('<li>The brain atlas is "'+atlas+'".</li>');
} else {
  errors.push('Cannot parse provider/atlas "'+sanitize(atlas.join('/'))+'"');
}

const dict = {};
console.log(loc);
loc = loc.split('&');
for (let i=0; i<loc.length; i++) {
  const kv = loc[i].split('=');
  if (kv.length === 2) dict[kv[0]] = kv[1];
  else errors.push('Cannot parse parameter "'+sanitize(kv.join('='))+'"');  
}
html.push('<li>The atlas modifier parameters are '+JSON.stringify(dict)+'.</li>');

const roi = {};
console.log(hash);
html.push('<li>The coordinate is '+JSON.stringify(hash)+'.</li>');



if (provider) {
  // validate provider
  ajaxPromise({ type:"GET", url:"/providers/providers.json", responseType:'json' })
  .then((xhr) => {
    const providers = xhr.response;
    if (providers.hasOwnProperty(provider)) {
      html.push('<li>Provider <a href="'+sanitizeUrl(providers[provider].url)+'">'+providers[provider].name+' ('+provider+')</a> is valid.</li>');
      document.getElementById('response').innerHTML = html.join('\n');
    } else {
      errors.push('Invalid provider "'+provider+'".');
    }
    displayResponse(html,errors);
  },(xhr) => {
    errors.push('Error while parsing provider: '+xhr.statusText);
    displayResponse(html,errors);
  });
}
displayResponse(html,errors);
</script>
